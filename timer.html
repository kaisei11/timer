<html>
    <body>
        <div id="timer">
            00:00:000
        </div>
        <div id="timerLap">
        </div>
        <div id="laps">
        </div>
        <div>
        <button id="timeStart">開始</button>
        <button id="timeStop">停止</button>
        <button id="timeReset">リセット</button>
        <button id="timeLap">ラップ</button>
        </div>
    <script type="text/javascript">
    const timeStart=document.getElementById('timeStart')
    const timeStop=document.getElementById('timeStop')
    const timeReset=document.getElementById('timeReset')

   
    let storedTime
    let startTime
    let timerId
    let timeToAdd = 0;
    
    const updateTimeText = () => {
      
        let minutes = Math.floor(storedTime / (1000 * 60));

        let seconds = Math.floor((storedTime % (1000 * 60)) / 1000);

        let miliseconds = storedTime % 1000;
    
        minutes = `0${minutes}`.slice(-2)
        seconds = `0${seconds}`.slice(-2)
        miliseconds = `00${miliseconds}`.slice(-3)
        timer.textContent=`${minutes}:${seconds}:${miliseconds}`
    }

    const countUp = () => {
        timerId = setTimeout(() => {
        storedTime = Date.now() - startTime + timeToAdd;
        updateTimeText();
        countUp();
        }, 10);
    }

    const timeLap=document.getElementById('timeLap')
    let storedLapTime
    let startLapTime
    let timerLapId
    let timeLapToAdd = 0;
    
    let beforeTimeLapToAdd =0;

    let i = 0;

    const updateLapTimeText = () => {
        let minutesLap = Math.floor(storedLapTime / (1000 * 60));
        let secondsLap = Math.floor((storedLapTime % (1000 * 60)) / 1000);
        let milisecondsLap = storedLapTime % 1000;

        minutesLap = `0${minutesLap}`.slice(-2)
        secondsLap = `0${secondsLap}`.slice(-2)
        milisecondsLap = `00${milisecondsLap}`.slice(-3)
        timerLap.textContent=`${minutesLap}:${secondsLap}:${milisecondsLap}`
    }

    const countLapUp = () => {
        timerLapId = setTimeout(() => {
        storedLapTime = Date.now() - startLapTime + timeLapToAdd;
        updateLapTimeText();
        countLapUp();
        }, 10);
    }
   
    const funcLap = () => {
        countLapUp();
        let parentDiv = document.createElement("ul");
        parentDiv.id = "laplist";
    
        document.body.appendChild(parentDiv);
    
        let laplist = document.getElementById("laplist");

        let lap = document.createElement("li");
        lap.setAttribute("id", "lap");

        laplist.appendChild(lap);
        timeLapToAdd += Date.now() - startLapTime;
        i = i+1

        let s = 0
        s = timeLapToAdd-beforeTimeLapToAdd;

        let minutes = Math.floor( s / (1000 * 60));
        let seconds = Math.floor(( s % (1000 * 60)) / 1000);
        let miliseconds = s % 1000;

        minutes = `0${minutes}`.slice(-2)
        seconds = `0${seconds}`.slice(-2)
        miliseconds = `00${miliseconds}`.slice(-3)
        
        lap.textContent = `ラップ${i} ${minutes}:${seconds}:${miliseconds}`;
        beforeTimeLapToAdd = timeLapToAdd
        timeLapToAdd=0
    }

    timeLap.addEventListener('click', funcLap, false)

    const Start = () => {
        startTime = Date.now();
        countUp();
        startLapTime = Date.now();
        countLapUp();
    }
    const Stop = () => {
        clearTimeout(timerId);
        timeToAdd += Date.now() - startTime;
        clearTimeout(timerLapId);
        timeLapToAdd += Date.now() - startLapTime;
    }
    const Reset = () => {
        storedTime = 0;
        timeToAdd = 0;
        updateTimeText();
        storedLapTime = 0;
        timeLapToAdd = 0;
        updateLapTimeText();
    }

    timeLap.addEventListener('click', funcLap, false)
    timeStart.addEventListener('click', Start, false)
    timeStop.addEventListener('click', Stop, false)
    timeReset.addEventListener('click', Reset, false)
     
    </script>
    </body>
</html>